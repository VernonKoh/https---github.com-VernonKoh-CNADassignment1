<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing and Payment</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            font-family: 'Poppins', sans-serif;
        }

        .vehicle-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }

        #payment-status {
            margin-top: 20px;
        }

        .billing-table th,
        .billing-table td {
            text-align: left;
        }

        .membership-info {
            margin-bottom: 30px;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="welcome.html">Home</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="update-profile.html">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="membership.html">Membership</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="logout.html">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Payment Section -->
    <div class="container">
        <h1>Vehicle Billing and Payment</h1>

        <!-- Membership Tier and Discount Info -->
        <div id="membership-info" class="membership-info">
            <p>Membership Tier: <span id="membership-tier">Loading...</span></p>
            <p>Discount Applied: <span id="discount-amount">Loading...</span></p>
        </div>

        <!-- Billing Details -->
        <div id="billing-details">
            <p>Loading billing details...</p>
        </div>

        <!-- Payment Status -->
        <div id="payment-status">
            <p>Status: <span id="payment-status-text">Waiting for payment...</span></p>
        </div>

        <!-- Payment Form -->
        <form id="payment-form">
            <div class="mb-3">
                <label for="paymentAmount" class="form-label">Total Amount</label>
                <input type="text" id="paymentAmount" class="form-control" disabled />
            </div>
            <button type="submit" class="btn btn-primary w-100">Pay Now</button>
        </form>
        


        <!-- Stripe Checkout -->
        <div id="stripe-checkout">
            <script src="https://js.stripe.com/v3/"></script>
            <button id="checkout-button" class="btn btn-success w-100">Proceed to Checkout</button>
        </div>
    </div>

    <script>
        const userID = localStorage.getItem('userID');
        const jwtToken = localStorage.getItem('jwtToken');
        let totalAmount = 0;

        if (!userID || !jwtToken) {
            alert('User not logged in!');
            window.location.href = 'login.html';
        }

        // Fetch billing details
        async function fetchBillingDetails() {
            try {
                const response = await fetch(`http://localhost:8083/api/v1/billing/bookings?user_id=${userID}`, {
                    headers: {
                        Authorization: `Bearer ${jwtToken}`
                    }
                });

                const responseBody = await response.text();
                console.log("Raw Response Body:", responseBody);

                if (!response.ok) {
                    throw new Error(`HTTP Status: ${response.status} - ${responseBody}`);
                }

                const data = JSON.parse(responseBody);

                if (data.billing_details) {
                    totalAmount = data.total_cost;
                    document.getElementById('paymentAmount').value = `$${totalAmount.toFixed(2)}`;

                    // Display membership tier and discount
                    document.getElementById('membership-tier').textContent = data.user_role;
                    document.getElementById('discount-amount').textContent = data.discount;

                    const billingDetailsDiv = document.getElementById('billing-details');
                    const table = document.createElement('table');
                    table.classList.add('table', 'billing-table');
                    let tableHTML = `
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Duration</th>
                                <th>Cost Before Discount</th>
                                <th>Discount</th>
                                <th>Final Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    data.billing_details.forEach(booking => {
                        tableHTML += `
                            <tr>
                                <td>${booking.vehicle}</td>
                                <td>${booking.start_time}</td>
                                <td>${booking.end_time}</td>
                                <td>${booking.duration}</td>
                                <td>${booking.cost_before_discount}</td>
                                <td>${booking.discount}</td>
                                <td>${booking.final_cost}</td>
                            </tr>
                        `;
                    });

                    tableHTML += `</tbody>`;
                    table.innerHTML = tableHTML;
                    billingDetailsDiv.innerHTML = '';
                    billingDetailsDiv.appendChild(table);
                } else {
                    throw new Error("Billing details are missing in the response");
                }
            } catch (error) {
                console.error('Error fetching billing details:', error);
                document.getElementById('billing-details').innerHTML = '<p>Failed to load billing details. Please try again later.</p>';
            }
        }

        // Handle Stripe checkout
        async function createCheckoutSession() {
            const response = await fetch('http://localhost:8083/api/v1/payment/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ amount: totalAmount * 100 }) // Convert to cents
            });

            const session = await response.json();
            return session.id;
        }

        document.getElementById('checkout-button').addEventListener('click', async () => {
            const sessionId = await createCheckoutSession();

            const stripe = Stripe('your-public-stripe-key');
            const { error } = await stripe.redirectToCheckout({ sessionId });

            if (error) {
                console.error('Error during checkout:', error);
            }
        });
        document.getElementById('payment-form').addEventListener('submit', async function (e) {
        e.preventDefault(); // Prevent form from submitting normally

        // Get payment amount and user id
        const paymentAmount = document.getElementById('paymentAmount').value;
        const userID = localStorage.getItem('userID');
        const jwtToken = localStorage.getItem('jwtToken');

        if (!userID || !jwtToken) {
            alert('User not logged in!');
            window.location.href = 'login.html'; // Redirect if not logged in
            return;
        }

        const paymentData = {
            user_id: userID,
            amount: paymentAmount,
            payment_method: "Stripe", // Assuming using Stripe
            payment_status: "pending", // Can be changed based on Stripe's response
        };

        try {
            const response = await fetch('http://localhost:8083/api/v1/payment/confirm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`, // Ensure you are passing the JWT token
                },
                body: JSON.stringify(paymentData), // Sending payment details to backend
            });

            const result = await response.json();

            if (response.ok) {
                // If payment confirmed
                alert("Payment confirmed!");
                window.location.href = '/payment-confirmed.html'; // Redirect to payment confirmation page
            } else {
                alert(`Payment failed: ${result.error || "Unknown error"}`);
            }
        } catch (error) {
            console.error("Error during payment:", error);
            alert("Failed to process payment. Please try again.");
        }
    });
        // Fetch billing details on page load
        fetchBillingDetails();
    </script>
</body>

</html>